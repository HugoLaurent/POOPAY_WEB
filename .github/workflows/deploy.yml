name: CI/CD Web

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: web-deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Web - Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

  deploy:
    name: Deploy to VPS
    needs: test
    runs-on: ubuntu-latest
    if: success()
    timeout-minutes: 15
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            # 1) MAJ du dépôt web
            cd /srv/docker/poopay/poopay_web
            git fetch origin main
            git reset --hard origin/main

            # 2) Build/Restart à l'endroit du docker-compose
            cd /srv/docker/poopay
            docker compose build web
            docker compose up -d web
            docker image prune -f

  notify:
    name: Notify Discord
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always() # s'exécute même en cas d'échec
    steps:
      - name: Send Discord notification
        shell: bash
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TEST_RESULT: ${{ needs.test.result }}
          DEPLOY_RESULT: ${{ needs.deploy.result }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "No DISCORD_WEBHOOK_URL secret set. Skipping Discord notify."
            exit 0
          fi

          status="failed"
          color=15548997   # rouge
          title="CI/CD: tests ou déploiement échoués"
          if [ "${DEPLOY_RESULT}" = "success" ]; then
            status="success"; color=5763719; title="CI/CD: déploiement réussi"
          elif [ "${TEST_RESULT}" = "success" ] && [ -z "${DEPLOY_RESULT}" ]; then
            status="warning"; color=16776960; title="CI/CD: tests OK (pas de déploiement)"
          fi

          short_sha=$(echo "$SHA" | cut -c1-7)

          JSON=$(cat <<EOF
          {
            "embeds": [
              {
                "title": "$title",
                "description": "**$REPO**\\n**Branche:** $BRANCH\\n**Commit:** \`$short_sha\`\\n**Auteur:** $ACTOR",
                "color": $color,
                "fields": [
                  { "name": "Tests",  "value": "\`$TEST_RESULT\`",   "inline": true },
                  { "name": "Deploy", "value": "\`$([ -z "$DEPLOY_RESULT" ] && echo skipped || echo $DEPLOY_RESULT)\`", "inline": true },
                  { "name": "Run",    "value": "[Ouvrir le run]($RUN_URL)", "inline": false }
                ]
              }
            ],
            "allowed_mentions": { "parse": [] }
          }
          EOF
          )

          curl -sS -H "Content-Type: application/json" \
               -X POST -d "$JSON" "$DISCORD_WEBHOOK_URL"
